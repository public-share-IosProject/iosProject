var wb;

var load = function() {
    var vm = new Vue({
        el: '#app',

        data: function() {
            return {
                money: 0,
                total_income: 0,
                total_expenditure: 0,
                banks: [],
                msgs: [],
                curPage: 1,
                finish: false
            };
        },

        created: function() {
            this.loadWalletInfo();
            this.loadBankList();
        },

        methods: {
            /**
             * 载入时获取钱包信息
             * @return
             */
            loadWalletInfo: function() {
                var self = this;
                var params = {
                    url: 'http://www.renrenshangjin.com/index.php?m=Home&c=UserWallet&a=getUserMoney',
                    ZYRJM: window.webEvn.token
                };

                wb.Ajax(params, function(data) {
                    if (data.status == 1 && data.money !== null) {
                        self.money = (data.money.money !== null) ? data.money.money : 0;
                        self.total_income = (data.money.total_income !== null) ? data.money.total_income : 0;
                        self.total_expenditure = (data.money.total_expenditure !== null) ? data.money.total_expenditure : 0;
                    } else {
                        wb.showTip(data.info);
                        self.close();
                    }
                });
            },

            /**
             * 加载用户已认证通过的银行卡列表
             * @return
             */
            loadBankList: function() {
                var self = this;

                var params = {
                    url: 'http://www.renrenshangjin.com/index.php?m=Home&c=UserBankCard&a=getUserBankCardLegalList',
                    ZYRJM: window.webEvn.token
                };

                wb.Ajax(params, function(data) {
                    if (data.status == 1) {
                        self.banks = data.banks;

                        var split = 3; // 空格分割位

                        // 银行卡号显示格式化
                        self.banks.forEach(function(card) {
                            var card_number = '';
                            for (var i = 0; i < card.card_number.length; i++) {
                                if (i == split - 1 ||
                                    i == split + 3 ||
                                    i == split + 7 ||
                                    i == split + 11 ||
                                    i == split + 15
                                ) {
                                    card_number += card.card_number.charAt(i) + ' ';
                                } else {
                                    card_number += card.card_number.charAt(i);
                                }
                            }

                            card.card_number = card_number;
                        });
                    } else {
                        wb.showTip(data.info);
                    }
                });
            },

            /**
             * 下拉刷新，重新加载数据
             * @param {object} me dropload对象
             * @return
             */
            loadUpData: function(me) {
                var self = this;
                self.finish = false;

                if (self.finish !== true) {
                    self.curPage = 1;
                    var params = {
                        url: 'http://www.renrenshangjin.com/index.php?m=Home&c=UserWallet&a=getUserWalletMessage',
                        ZYRJM: window.webEvn.token,
                        curPage: self.curPage
                    };

                    wb.Ajax(params, function(data) {
                        if (data.status == 1) {
                            if (data.messages !== null && data.messages.length !== 0) {
                                self.curPage++;
                                $('#walletMsgs').html(self.dataProcessor(data.messages));
                            } else {
                                self.finish = true;
                                me.noData();
                            }
                        } else {
                            wb.showTip(data.info);
                            me.noData();
                        }
                        me.resetload();
                        $('.dropload-noData').replaceWith('<div class="dropload-refresh">↑上拉加载更多</div>');
                    });
                } else {
                    me.noData();
                    me.resetload();
                }
            },

            /**
             * 上滑追加下方数据
             * @param  {object} me dropload对象
             * @return
             */
            loadDownData: function(me) {
                var self = this;

                if (self.finish !== true) {
                    var params = {
                        url: 'http://www.renrenshangjin.com/index.php?m=Home&c=UserWallet&a=getUserWalletMessage',
                        ZYRJM: window.webEvn.token,
                        curPage: self.curPage
                    };

                    wb.Ajax(params, function(data) {
                        if (data.status == 1) {
                            if (data.messages !== null && data.messages.length !== 0) {
                                self.curPage++;
                                $('#walletMsgs').append(self.dataProcessor(data.messages));
                            } else {
                                self.finish = true;
                                me.noData();
                            }
                        } else {
                            me.noData();
                        }
                        me.resetload();
                    });
                } else {
                    me.noData();
                    me.resetload();
                }
            },

            /**
             * 对相应的数据进行处理
             * @param  {array} items 响应数据
             * @return {string} 处理结果
             */
            dataProcessor: function(items) {
                var result = '';
                items.forEach(function(item) {
                    item.detail = (item.detail !== null) ? item.detail : '';

                    var date = new Date(item.created_at * 1000);
                    item.created_at = date.getFullYear() + '.' + (date.getMonth() + 1) + '.' + (date.getDate()) + ' ' + date.getHours() + ':' + date.getMinutes();

                    var taskType = '';
                    item.status = parseInt(item.status);

                    var isMoney = true;
                    switch (item.status) {
                        case 1: // 发布任务
                            taskType = '任务';
                            if (parseFloat(item.money) > 0) {
                                item.money = '+' + item.money;
                            }
                            break;
                        case 2: // 完成任务
                            taskType = '任务';
                            item.money = '+' + item.money;
                            break;
                        case 3: // 充值
                            taskType = '充值';
                            item.money = '+' + item.money;
                            break;
                        case 4: // 提现
                            taskType = '提现';
                            item.money = '-' + item.money;
                            break;
                        case 5: // 积分消费
                            taskType = '需求卡';
                            isMoney = false;
                            item.money = '-' + parseInt(item.money) + '积分';
                            break;
                        case 6: // 金额消费
                            taskType = '需求卡';
                            item.money = '-' + item.money;
                            break;
                        case 7: // 提现退款
                            taskType = '退款';
                            item.money = '+' + item.money;
                            break;
                        case 8: // 任务退款
                            taskType = '退款';
                            item.money = '+' + item.money;
                            break;
                    }

                    item.taskType = taskType;

                    if (isMoney) {
                        item.money = item.money + '元';
                    }

                    result +=
                        '<div class="ui-row-flex ui-whitespace border-t wallet-task">' +
                        '<div class="ui-col ui-col-2">' +
                        '<div class="ui-row-flex wallet-task-left">' +
                        '<div class="ui-col thebadge">' + item.taskType + '</div>' +
                        '<div class="ui-col ui-col-4 ui-nowrap task_name_word">' + item.detail + '</div>' +
                        '</div>' +
                        '</div>' +
                        '<div class="ui-col">' +
                        '<div class="ui-nowrap task_point">' + item.money + '</div>' +
                        '<div class="task_time">' + item.created_at + '</div>' +
                        '</div>' +
                        '</div>';
                });
                return result;
            },

            deleteBankCard: function(id) {
                wb.Alert('提示', '是否要删除该银行卡', function(data) {
                    if (data.status == 1) {
                        var self = this;

                        var params = {
                            url: 'http://www.renrenshangjin.com/index.php?m=Home&c=UserBankCard&a=postUserBankCardDelete',
                            ZYRJM: window.webEvn.token,
                            card_id: id
                        };

                        wb.Ajax(params, function(data) {
                            if (data.status == 1) {
                                wb.showTip('删除成功');
                                window.location.reload();
                            } else {
                                wb.showTip(data.info);
                            }
                        });
                    }
                });

            },

            /**
             * 跳转至充值页面
             * @return
             */
            go2Recharge: function() {
                window.location.href = 'recharge.html';
            },

            /**
             * 跳转至提现页面
             * @return
             */
            go2Withdraw: function() {
                var params = {
                    url: 'http://www.renrenshangjin.com/index.php?m=Home&c=UserIDCard&a=getUserIDCardInfor',
                    ZYRJM: window.webEvn.token
                };

                wb.Ajax(params, function(data) {
                    if (data.status == 1 && data.idcard !== undefined) {
                        // 判断用户是否已通过实名认证
                        if (data.idcard === null || data.idcard.status == 3) { // 尚未认证或者认证失败
                            wb.showTip('请先进行认证');
                            setTimeout(function() {
                                window.location.href = 'myAuth.html';
                            }, 1000);
                        } else if (data.idcard.status == 1) { // 认证审核中
                            wb.showTip('认证正在审核中');
                        } else if (data.idcard.status == 2) { // 认证已通过
                            window.location.href = 'withdraw.html';
                        }
                    } else {
                        wb.showTip(data.info);
                    }
                });
            },

            /**
             * 跳转至添加银行卡页面
             * @return
             */
            go2PlusBankCard: function() {
                window.location.href = 'addBankCard.html';
            },

            /**
             * 关闭当前页面
             * @return
             */
            close: function() {
                wb.Finish();
            }
        }
    });

    window.webEvn.close = vm.close;

    var dropload = $('#content').dropload({
        $touchArea: $('.pages'),
        scrollArea: window,
        domUp: {
            domClass: 'dropload-up',
            domRefresh: '<div class="dropload-refresh">↓下拉刷新</div>',
            domUpdate: '<div class="dropload-update">↑释放更新</div>',
            domLoad: '<div class="dropload-load"><span class="loading"></span>加载中...</div>'
        },
        domDown: {
            domClass: 'dropload-down',
            domRefresh: '<div class="dropload-refresh">↑上拉加载更多</div>',
            domLoad: '<div class="dropload-load"><span class="loading"></span>加载中...</div>',
            domNoData: '<div class="dropload-noData">列表都加载完啦</div>'
        },
        autoLoad: true,
        loadDownFn: function(me) {
            vm.loadDownData(me);
        },
        loadUpFn: function(me) {
            vm.loadUpData(me);
        }
    });
};

$(document).ready(function() {
    wb = new webLib();
    wb.debug(true);
    wb.init(load, true);
});
