var vmData = {
    respLength: 8,
    preUrl: 'http://www.renrenshangjin.com/',
    defaultImg: 'img/user_header.png',
    smImg: '%23S%23.',
    newWinCmd: 'demand://'
};

var wb, vm;

var load = function() {
    vm = new Vue({
        el: '#app',

        data: function() {
            return {
                items: [
                    [],
                    []
                ],
                msgs: [],
                msgIndex: 0,
                smImg: vmData.smImg,
                curPage: 1,
                finish: [false, false],
                itemIndex: 0,
                curItem: 0,
                defaultImg: vmData.defaultImg,
                preUrl: vmData.preUrl,
                userMsgIsReddot: false,
                sysMsgIsReddot: false
            };
        },

        created: function() {
            this.loadCurItem();
            this.isUserMsgReddot();
            this.isSysMsgReddot();
        },

        methods: {
            loadCurItem: function() {
                var data = wb.getData();
                if (data.msg_curItem !== undefined &&
                    data.msg_curItem !== null &&
                    data.msg_curItem !== '') {
                    this.curItem = data.msg_curItem;
                    this.itemIndex = this.curItem;
                } else {
                    this.curItem = 0;
                }
            },

            isUserMsgReddot: function() {
                var self = this;

                var params = {
                    url: 'http://www.renrenshangjin.com/index.php?m=Home&c=UserMessage&a=getReadMessage',
                    ZYRJM: window.webEvn.token
                };

                wb.Ajax(params, function(data) {
                    if (data.status == 1 && data.is_read == 1) {
                        self.userMsgIsReddot = true;
                    }
                });
            },

            isSysMsgReddot: function() {
                var self = this;

                var params = {
                    url: 'http://www.renrenshangjin.com/index.php?m=Home&c=Notice&a=getUserNoticeExistRead',
                    ZYRJM: window.webEvn.token
                };

                wb.Ajax(params, function(data) {
                    if (data.status == 1 && data.exist == 1) {
                        self.sysMsgIsReddot = true;
                    }
                });
            },

            /**
             * 上滑追加下方数据
             * @param  {object} me - dropload对象
             * @param  {number} type - 请求参数
             * @return
             */
            loadDownData: function(me, type) {
                var self = this;

                if (self.finish[self.itemIndex] !== true) {
                    var params = {
                        url: 'http://www.renrenshangjin.com/index.php?m=Home&c=UserMessage&a=getIndex',
                        ZYRJM: window.webEvn.token,
                        curPage: self.curPage,
                        type: type
                    };

                    wb.Ajax(params, function(data) {
                        if (data.status == 1) {
                            if (data.messages !== null && data.messages.length !== 0) {
                                self.curPage++;

                                data.messages.forEach(function(msg) {
                                    self.msgs.push(msg);
                                });

                                $('#lists' + (self.itemIndex + 1)).append(self.dataProcessor(data.messages));
                            } else {
                                self.finish[self.itemIndex] = true;
                                me.noData();
                            }
                        } else {
                            me.noData();
                        }
                        me.resetload();
                    });
                } else {
                    me.noData();
                    me.resetload();
                }
            },

            /**
             * 下拉刷新，重新加载数据
             * @param  {object} me   dropload对象
             * @param  {number} type 请求参数
             * @return
             */
            loadUpData: function(me, type) {
                var self = this;

                self.finish[self.itemIndex] = false;
                self.curPage = 1;

                var params = {
                    url: 'http://www.renrenshangjin.com/index.php?m=Home&c=UserMessage&a=getIndex',
                    ZYRJM: window.webEvn.token,
                    curPage: self.curPage,
                    type: type
                };

                wb.Ajax(params, function(data) {
                    if (data.status == 1) {
                        if (data.messages !== null && data.messages.length !== 0) {
                            self.curPage++;

                            self.msgs = data.messages;
                            $('#lists' + (self.itemIndex + 1)).html(self.dataProcessor(data.messages));
                            if (data.messages.length < vmData.respLength) {
                                $('.dropload-noData').replaceWith('<div class="dropload-noData">任务都加载完啦</div>');
                            } else {
                                $('.dropload-noData').replaceWith('<div class="dropload-refresh">↑上拉加载更多</div>');
                            }
                        } else {
                            self.finish[self.itemIndex] = true;
                            me.noData();
                        }
                    } else {
                        wb.showTip(data.info);
                        me.noData();
                    }
                    me.resetload();
                });
            },

            /**
             * 数据处理
             * @param  {array} items 数据
             * @return
             */
            dataProcessor: function(items) {
                var self = this;
                var result = '';

                switch (vm.itemIndex) {
                    case 0:
                        items.forEach(function(item) {
                            var date = new Date(item.created_at * 1000);

                            var minutes = parseInt(date.getMinutes());
                            if (minutes === 0) {
                                minutes = '00';
                            } else if (minutes < 10) {
                                minutes = '0' + minutes;
                            }

                            var time = date.getFullYear() + '.' + (date.getMonth() + 1) + '.' + (date.getDate()) + ' ' + date.getHours() + ':' + minutes;
                            item.time = time;

                            if (item.url === null || item.url === '') {
                                item.url = self.defaultImg;
                            } else {
                                item.url = self.preUrl + item.url.replace('\.', self.smImg);
                            }
                            result += self.htmlConcatSysMsg(item);
                        });
                        break;
                    case 1:
                        items.forEach(function(item) {
                            var date = new Date(item.created_at * 1000);

                            var minutes = parseInt(date.getMinutes());
                            if (minutes === 0) {
                                minutes = '00';
                            } else if (minutes < 10) {
                                minutes = '0' + minutes;
                            }

                            var time = date.getFullYear() + '.' + (date.getMonth() + 1) + '.' + (date.getDate()) + ' ' + date.getHours() + ':' + minutes;
                            item.time = time;

                            result += self.htmlConcatBulletin(item);
                        });
                        break;
                }

                return result;
            },

            /**
             * 系统消息html拼接
             * @param  {array} item 数据
             * @return
             */
            htmlConcatSysMsg: function(item) {
                var taskType, headImg;

                switch (parseInt(item.type)) {
                    case 1:
                        taskType = '任务';
                        break;
                    case 2:
                        taskType = '添加好友';
                        break;
                    case 3:
                        taskType = '申请延长';
                        break;
                    case 4:
                        taskType = '提现';
                        break;
                    case 5:
                        taskType = '消息反馈';
                        break;
                    case 10:
                        taskType = '任务';
                        break;
                }

                var isReddot = (item.is_read) == 0 ? ' ui-reddot' : '';

                return '<a class="item opacity" onclick="openUserMsg(event)" tid="' + this.msgIndex++ + '">' +
                    '<div class="ui-row-flex my_message">' +
                    '<div class="ui-col"><img src="' + item.url + '" class="my_msgphoto"></div>' +
                    '<div class="ui-col ui-col-5 ui-row-flex ui-row-flex-ver">' +
                    '<div class="ui-col taskinfo-up">' +
                    '<span>' + item.username + '</span>' +
                    '<span class="tasktype">' + taskType + '</span>' +
                    '<span class="tasktime' + isReddot + '">' + item.time + '</span>' +
                    '</div>' +
                    '<div class="ui-col ui-col-2 taskinfo-down">' +
                    '<div class="ui-nowrap-multi">' + item.detail + '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</a>';
            },

            /**
             * 公告html拼接
             * @param  {array} item 数据
             * @return
             */
            htmlConcatBulletin: function(item) {
                var isReddot = (item.is_read) == 0 ? ' ui-reddot' : '';

                return '<div class="ui-row-flex ui-whitespace my_message" onclick="openSysMsg(event)" tid="' + this.msgIndex++ + '">' +
                    '<div class="ui-col ui-col-5">' +
                    '<div class="ui-row-flex ui-whitespace my_name_time">' +
                    '<div class="ui-col ui-col-3">' +
                    '<div class="ui-nowrap msg_bulletin_title">' +
                    '<span>' + item.title + '</span>' +
                    '</div>' +
                    '</div>' +
                    '<div class="ui-col ui-col-2">' +
                    '<div class="my_message_time' + isReddot + '">' + item.time + '</div>' +
                    '</div>' +
                    '</div>' +
                    '<div class="ui-row-flex ui-whitespace msg_bulletin_content"><div class="ui-col ui-nowrap">' + item.content +
                    '</div></div>' +
                    '</div>' +
                    '</div>';
            },

            /**
             * 关闭当前页面
             * @return
             */
            close: function() {
                var data = wb.getData();
                if (data.msg_curItem !== undefined) {
                    data.msg_curItem = null;
                }
                wb.setData(data, function() {
                    wb.Finish();
                });
            }
        }
    });

    window.webEvn.close = vm.close;

    var dropload = $('.content').dropload({
        $touchArea: $('.pages'),
        scrollArea: window,
        domUp: {
            domClass: 'dropload-up',
            domRefresh: '<div class="dropload-refresh">↓下拉刷新</div>',
            domUpdate: '<div class="dropload-update">↑释放更新</div>',
            domLoad: '<div class="dropload-load"><span class="loading"></span>加载中...</div>'
        },
        domDown: {
            domClass: 'dropload-down',
            domRefresh: '<div class="dropload-refresh">↑上拉加载更多</div>',
            domLoad: '<div class="dropload-load"><span class="loading"></span>加载中...</div>',
            domNoData: '<div class="dropload-noData">列表都加载完啦</div>'
        },
        autoLoad: true,

        loadDownFn: function(me) {
            var self = vm;
            self.loadDownData(me, whichCase(self.itemIndex));
        },

        loadUpFn: function(me) {
            var self = vm;
            self.loadUpData(me, whichCase(self.itemIndex));
        }
    });

    $('.tab .item').on('tap', function() {
        var $this = $(this);
        var $vm = vm;
        $vm.itemIndex = $this.index();

        $vm.curPage = 1;
        $vm.finish.$set($vm.itemIndex, false);
        $vm.$set('msgs', []);
        $vm.msgIndex = 0;

        $this.addClass('cur').siblings('.item').removeClass('cur');
        $('#lists' + ($vm.itemIndex + 1)).show().siblings('.item').hide();
        $('#lists' + ($vm.itemIndex + 1)).html('');

        dropload.unlock();
        dropload.noData(false);
        dropload.resetload();
    });

    /*var tab = new fz.Scroll('.ui-tab', {
        role: 'tab',
        autoplay: false,
        interval: 3000,
        indicator: false
    });*/

    (function addCurClass() {
        $($('.tab').children()[vm.curItem]).addClass('cur').siblings('.item').removeClass('cur');
    })();
};

$(document).ready(function() {
    wb = new webLib();
    wb.debug(true);
    wb.init(load, true);
});

/**
 * 判断当前是哪个列表
 * @param  {number} itemIndex - 当前列表下标
 * @return {number} type - 请求状态码
 * @return {number} index - 当前数组下标
 */
function whichCase(itemIndex) {
    var type;

    switch (itemIndex) {
        case 0:
            type = 1;
            break;
        case 1:
            type = 2;
            break;
    }

    return type;
}

function openUserMsg(e) {
    var $this = $(e.currentTarget);
    var tid = $this.attr('tid');
    var curData = vm.msgs[tid];

    var data = wb.getData();

    data.msg_curItem = vm.itemIndex;

    var msg = {
        id: curData.id,
        type: curData.type,
        created_at: curData.created_at,
        sender_id: curData.sender_id,
        detail: curData.detail,
        task_id: curData.task_id,
        is_read: curData.is_read
    };

    data.userMsgData = msg;

    /*清除小红点*/
    if (curData.is_read == 0) {

        var params = {
            url: 'http://www.renrenshangjin.com/index.php?m=Home&c=UserMessage&a=postMessageSet',
            ZYRJM: window.webEvn.token,
            message_id: curData.id
        };
        wb.Ajax(params, function(data) {});
    }

    switch (parseInt(curData.type)) {
        case 1:
            taskResultHelper(curData.task_id, curData.type, function(address) {
                if (address !== '') {
                    wb.setData(data, function() {
                        window.location.href = vmData.newWinCmd + address;
                    });
                } else {
                    wb.showTip('未知错误');
                    close();
                }
            });
            break;
        case 2:
            wb.setData(data, function() {
                window.location.href = vmData.newWinCmd + 'friendReq.html';
            });
            break;
        case 3:
            wb.setData(data, function() {
                window.location.href = vmData.newWinCmd + 'extendReq.html';
            });
            break;
        case 4:
            wb.setData(data, function() {
                window.location.href = vmData.newWinCmd + 'withdrawResult.html';
            });
            break;
        case 5:
            wb.setData(data, function() {
                window.location.href = vmData.newWinCmd + 'msgResult.html';
            });
            break;
        case 10:
            taskResultHelper(curData.task_id, curData.type, function(address) {
                if (address !== '') {
                    wb.setData(data, function() {
                        window.location.href = vmData.newWinCmd + address;
                    });
                } else {
                    wb.showTip('未知错误');
                    close();
                }
            });
            break;
    }

}

function openSysMsg(e) {
    var $this = $(e.currentTarget);
    var tid = $this.attr('tid');
    var curData = vm.msgs[tid];

    var data = wb.getData();

    data.msg_curItem = vm.itemIndex;

    data.sysMsgData = curData;

    /*清除小红点*/
    if (curData.is_read == 0) {
        var params = {
            url: 'http://www.renrenshangjin.com/index.php?m=Home&c=Notice&a=postNoticeRead',
            ZYRJM: window.webEvn.token,
            notice_id: curData.id
        };

        wb.Ajax(params, function(data) {});
    }

    wb.setData(data, function() {
        var data = wb.getData();
        window.location.href = vmData.newWinCmd + 'sysMsg.html';
    });
}

/**
 * 任务类型判断
 * @param  {[type]}   task_id  [description]
 * @param  {[type]}   type     [description]
 * @param  {Function} callback [description]
 * @return
 */
function taskResultHelper(task_id, type, callback) {
    var params = {
        url: 'http://www.renrenshangjin.com/index.php?m=Home&c=Task&a=postCheckTaskType',
        ZYRJM: window.webEvn.token,
        task_id: task_id,
        type: type
    };

    wb.Ajax(params, function(data) {
        var href = '';

        if (data.status == 1 && data.task_type != 0) {
            switch (parseInt(data.task_type)) {
                case 1:
                    href = 'demandReleased.html';
                    break;
                case 2:
                    href = 'demandReleasing.html';
                    break;
                case 3:
                    href = 'demandAttached.html';
                    break;
                case 4:
                    href = 'demandReleaseSolved.html';
                    break;
                case 5:
                    href = 'demandReleaseUnsolved.html';
                    break;
                case 6:
                    href = 'demandAttachUnsolved.html';
                    break;
            }

            callback(href);
        } else {
            wb.showTip('消息已过期');
            close();
        }
    });
}
